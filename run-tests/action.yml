name: 'Run QA Test Suite'
description: 'ðŸ§ª Core engine for executing API, GUI, and Performance tests with service orchestration and health checks.'
branding:
  icon: 'play-circle'
  color: 'blue'
inputs:
  start-services-command:
    description: '[DEPRECATED] Use setup-services action instead. Command to start background services.'
    required: false
    default: ''
  health-check-urls:
    description: '[DEPRECATED] Use setup-services action instead. Space-separated URLs to wait for.'
    required: false
    default: ''
  test-command-api:
    description: 'Command for API tests (e.g., npm run test:api)'
    required: false
    default: ''
  test-command-performance:
    description: 'Command for Performance tests (e.g., locust -f locustfile.py)'
    required: false
    default: ''
  test-command-gui:
    description: 'Command for GUI tests (e.g., npm run test:gui)'
    required: false
    default: ''
  headless:
    description: 'Run GUI tests in headless mode'
    required: false
    default: 'true'
  enable-coverage:
    description: 'Whether to collect code coverage'
    required: false
    default: 'false'
  coverage-module:
    description: 'Module to collect coverage for'
    required: false
    default: ''
  project-name:
    description: 'Name of the project (e.g., dashboard, ciber). Used for report folder naming.'
    required: false
    default: 'dashboard'

runs:
  using: 'composite'
  steps:
    - name: ðŸ§¹ Pre-execution Cleanup
      shell: bash
      run: |
        echo "::group::Cleanup stale reports"
        rm -rf reports/
        mkdir -p reports/test_run
        mkdir -p reports/performance_run
        echo "Cleanup complete."
        echo "::endgroup::"

    - name: ðŸš€ Start Services
      if: inputs.start-services-command != ''
      shell: bash
      run: |
        ${{ inputs.start-services-command }}
          
    - name: â³ Wait for Services
      if: inputs.health-check-urls != ''
      shell: bash
      run: |
        npx wait-on ${{ inputs.health-check-urls }} --timeout 60000 || (cat backend.log 2>/dev/null || true && cat frontend.log 2>/dev/null || true && exit 1)

    - name: â° Set Run Timestamp
      id: timestamp
      shell: bash
      run: echo "ts=$(date +'%Y-%m-%d_%H-%M-%S')" >> "$GITHUB_OUTPUT"

    - name: ðŸ§ª Run API Tests
      if: inputs.test-command-api != ''
      shell: pwsh
      run: |
        $enableCoverage = "${{ inputs.enable-coverage }}" -eq "true"
        $coverageModule = "${{ inputs.coverage-module }}"
        $reportDir = "reports/test_run/${{ inputs.project-name }}_${{ steps.timestamp.outputs.ts }}"
        
        if ($enableCoverage -and $coverageModule) {
          echo "::notice::Running API tests with coverage for module: $coverageModule"
          pytest --cov=$coverageModule tests/ --cov-report=xml
        } else {
          echo "::notice::Running standard API tests"
          $cmd = "${{ inputs.test-command-api }} --junit-dir $reportDir"
          Invoke-Expression $cmd
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        }

    - name: ðŸ§ª Run Performance Tests
      if: inputs.test-command-performance != ''
      shell: pwsh
      run: |
        echo "::notice::Executing Performance Stability Audit"
        ${{ inputs.test-command-performance }}

    - name: ðŸ§ª Run GUI Tests
      if: inputs.test-command-gui != ''
      shell: pwsh
      run: |
        echo "::notice::Executing GUI Verification Suite"
        $reportDir = "reports/test_run/${{ inputs.project-name }}_${{ steps.timestamp.outputs.ts }}"
          $cmd = "${{ inputs.test-command-gui }} --junit-dir $reportDir"
          Invoke-Expression $cmd
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
      env:
        HEADLESS: ${{ inputs.headless }}
