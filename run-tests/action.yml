name: 'Run QA Test Suite'
description: 'ðŸ§ª Core engine for executing API, GUI, and Performance tests with service orchestration and health checks.'
branding:
  icon: 'play-circle'
  color: 'green'
inputs:
  start-services-command:
    description: '[DEPRECATED] Use setup-services action instead. Command to start background services.'
    required: false
    default: ''
  health-check-urls:
    description: '[DEPRECATED] Use setup-services action instead. Space-separated URLs to wait for.'
    required: false
    default: ''
  test-command-api:
    description: 'Command for API tests (e.g., npm run test:api)'
    required: false
    default: ''
  test-command-performance:
    description: 'Command for Performance tests (e.g., locust -f locustfile.py)'
    required: false
    default: ''
  test-command-gui:
    description: 'Command for GUI tests (e.g., npm run test:gui)'
    required: false
    default: ''
  headless:
    description: 'Run GUI tests in headless mode'
    required: false
    default: 'true'
  enable-coverage:
    description: 'Whether to collect code coverage'
    required: false
    default: 'false'
  coverage-module:
    description: 'Module to collect coverage for'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Start Services
      if: inputs.start-services-command != ''
      shell: bash
      run: |
        ${{ inputs.start-services-command }}
          
    - name: Wait for Services
      if: inputs.health-check-urls != ''
      shell: bash
      run: |
        npx wait-on ${{ inputs.health-check-urls }} --timeout 60000 || (cat backend.log 2>/dev/null || true && cat frontend.log 2>/dev/null || true && exit 1)

    - name: Run API Tests
      if: inputs.test-command-api != ''
      shell: pwsh
      run: |
        if ("${{ inputs.enable-coverage }}" -eq "true" -and "${{ inputs.coverage-module }}" -ne "") {
          pytest --cov=${{ inputs.coverage-module }} tests/ --cov-report=xml
        } else {
          ${{ inputs.test-command-api }}
        }
        # Standardize report stashing for this infrastructure
        if (Test-Path "reports") {
          cp -r reports api_reports_tmp
          rm -rf reports/test_run
        }

    - name: Run Performance Tests
      if: inputs.test-command-performance != ''
      shell: pwsh
      run: |
        ${{ inputs.test-command-performance }}

    - name: Run GUI Tests
      if: inputs.test-command-gui != ''
      shell: pwsh
      run: |
        ${{ inputs.test-command-gui }}
      env:
        HEADLESS: ${{ inputs.headless }}
