name: 'PR Milestoner'
description: 'ðŸŽ¯ Automatically assigns the latest open milestone to a Pull Request.'
branding:
  icon: 'target'
  color: 'blue'

inputs:
  github-token:
    description: 'The GITHUB_TOKEN or a personal access token'
    required: true
  strategy:
    description: 'Selection strategy: "latest_created" or "next_due"'
    required: false
    default: 'latest_created'

runs:
  using: 'composite'
  steps:
    - name: Auto Milestone
      shell: bash
      run: |
        REPO="${{ github.repository }}"
        PR_NUMBER="${{ github.event.pull_request.number }}"
        
        if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" == "null" ]; then
          echo "No PR number found. Skipping milestone assignment."
          exit 0
        fi

        echo "Fetching milestones for $REPO..."
        
        if [ "${{ inputs.strategy }}" == "next_due" ]; then
          MILESTONE_NUMBER=$(gh api repos/$REPO/milestones --jq 'sort_by(.due_on) | .[0].number')
        else
          MILESTONE_NUMBER=$(gh api repos/$REPO/milestones --jq 'sort_by(.created_at) | reverse | .[0].number')
        fi

        if [ "$MILESTONE_NUMBER" != "null" ] && [ -n "$MILESTONE_NUMBER" ]; then
          echo "Assigning PR #$PR_NUMBER to milestone #$MILESTONE_NUMBER"
          gh pr edit "$PR_NUMBER" --milestone "$MILESTONE_NUMBER" --repo "$REPO"
        else
          echo "No open milestones found in $REPO."
        fi
      env:
        GH_TOKEN: ${{ inputs.github-token }}
