---
name: 'Collect and Publish QA Results'
description: 'ðŸ“Š Aggregate JUnit results, upload artifacts, and publish reporter summaries with configurable paths.'
branding:
  icon: 'share-2'
  color: 'orange'
inputs:
  reports-path:
    description: 'Path to test reports directory (API/GUI)'
    required: false
    default: ''
  screenshots-path:
    description: 'Path/Pattern for screenshots (e.g., screenshots/*.png)'
    required: false
    default: ''
  performance-reports-path:
    description: 'Path to performance reports directory'
    required: false
    default: ''
  junit-results-dir:
    description: 'Directory where all JUnit XMLs will be aggregated'
    required: false
    default: 'junit-results'
  upload-artifacts:
    description: 'Whether to upload artifact reports'
    required: false
    default: 'true'
  publish-results:
    description: 'Whether to publish the test reporter summary'
    required: false
    default: 'true'

runs:
  using: 'composite'
  steps:
    - name: ðŸ“‚ Collect All JUnit XMLs
      shell: bash
      run: |
        mkdir -p ${{ inputs.junit-results-dir }}
        if [ "${{ inputs.reports-path }}" != "" ] && [ -d "${{ inputs.reports-path }}" ]; then
          find ${{ inputs.reports-path }} -name "*.xml" -not -path "*/seed_*" -exec cp {} ${{ inputs.junit-results-dir }}/ \;
        fi
        echo "Collected $(find ${{ inputs.junit-results-dir }} -maxdepth 1 -name "*.xml" | wc -l) XML files."

    - name: ðŸ“¤ Upload Test Reports
      if: inputs.upload-artifacts == 'true' && inputs.reports-path != ''
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: ${{ inputs.reports-path }}

    - name: ðŸ“¤ Upload GUI Screenshots
      if: inputs.upload-artifacts == 'true' && inputs.screenshots-path != ''
      uses: actions/upload-artifact@v4
      with:
        name: gui-screenshots
        path: ${{ inputs.screenshots-path }}

    - name: ðŸ“¤ Upload Performance Reports
      if: inputs.upload-artifacts == 'true' && inputs.performance-reports-path != ''
      uses: actions/upload-artifact@v4
      with:
        name: performance-reports
        path: ${{ inputs.performance-reports-path }}

    - name: ðŸ“¢ Publish Test Results (PR)
      if: inputs.publish-results == 'true'
      uses: dorny/test-reporter@v1
      with:
        name: Unified Test Report
        path: ${{ inputs.junit-results-dir }}/*.xml
        reporter: java-junit
        fail-on-error: false

    - name: ðŸ“Š Generate Job Summary
      shell: bash
      run: |
        {
          echo "### ðŸš¦ Test Suite Summary"
          echo "| Test Type | Status |"
          echo "| :--- | :--- |"
          if [ "${{ inputs.reports-path }}" != "" ]; then
            if [ -d "${{ inputs.reports-path }}" ]; then
              echo "| ðŸ§ª Test Results | âœ… Completed |"
            else
              echo "| ðŸ§ª Test Results | âŒ Failed/Missing |"
            fi
          fi
        } >> "$GITHUB_STEP_SUMMARY"
